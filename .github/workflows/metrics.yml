name: Metrics

on:
  schedule:
    # 00:00 and 12:00 at America/Fortaleza (UTC-3)
    - cron: "0 3 * * *"
    - cron: "0 15 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  display_metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Stats Card (Action-generated)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.base.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          base: header, activity, community, repositories, metadata
          base_indepth: yes
          config_timezone: America/Fortaleza
          repositories_forks: yes
          repositories_affiliations: owner, collaborator, organization_member

      - name: Generate Trophies Card (Action-generated)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.achievements.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          base: ""
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year

      - name: Generate Achievements Detailed Card (Action-generated)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.achievements.detailed.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          base: ""
          plugin_achievements: yes
          plugin_achievements_display: detailed
          plugin_achievements_ignored: manager, managers

      - name: Patch Achievements Detailed SVG on API deprecation
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";
            const path = "metrics.plugin.achievements.detailed.svg";

            const current = await github.rest.repos.getContent({
              owner,
              repo,
              path,
              ref: `heads/${branch}`,
            });

            const file = Array.isArray(current.data) ? null : current.data;
            if (!file || !file.content || !file.sha) {
              core.setFailed(`Could not load ${path} from ${branch}`);
              return;
            }

            let svg = Buffer.from(file.content, "base64").toString("utf8");
            if (!/Unexpected error/i.test(svg)) {
              core.info("Achievements detailed SVG rendered without plugin errors.");
              return;
            }

            const { data: profile } = await github.rest.users.getByUsername({ username: "gabrielldn" });
            const joined = new Date(profile.created_at).toISOString().slice(0, 10);

            // Upstream plugin still queries Projects (classic), which now errors in GraphQL.
            const fallback = `
                    <section class="achievements largeable-flex-wrap">
                        <div class="field">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                                <path fill-rule="evenodd" d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 2.5a.75.75 0 01.75.75v3.44l2.02 1.52a.75.75 0 11-.9 1.2L7.55 8.67A.75.75 0 017.25 8V4.25A.75.75 0 018 3.5z"/>
                            </svg>
                            Detailed achievements temporarily unavailable (GitHub Projects classic sunset).
                        </div>
                        <div class="field">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                                <path fill-rule="evenodd" d="M1.75 1h12.5c.69 0 1.25.56 1.25 1.25v11.5c0 .69-.56 1.25-1.25 1.25H1.75A1.25 1.25 0 01.5 13.75V2.25C.5 1.56 1.06 1 1.75 1zm0 1.5a.25.25 0 00-.25.25v11c0 .14.11.25.25.25h12.5a.25.25 0 00.25-.25v-11a.25.25 0 00-.25-.25H1.75z"/>
                            </svg>
                            Public repositories: ${profile.public_repos}
                        </div>
                        <div class="field">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                                <path fill-rule="evenodd" d="M8 1.25a6.75 6.75 0 100 13.5A6.75 6.75 0 008 1.25zM2.75 8a5.25 5.25 0 118.36 4.2A3.75 3.75 0 008 9.75a3.75 3.75 0 00-3.11 2.45A5.23 5.23 0 012.75 8zM8 8.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z"/>
                            </svg>
                            Followers: ${profile.followers} | Following: ${profile.following}
                        </div>
                        <div class="field">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                                <path fill-rule="evenodd" d="M4.75 1A1.75 1.75 0 003 2.75v10.5C3 14.216 3.784 15 4.75 15h6.5A1.75 1.75 0 0013 13.25V4.81a1.75 1.75 0 00-.513-1.237L10.427 1.51A1.75 1.75 0 009.19 1H4.75zm4.69 1.56 2 2A.25.25 0 0111.25 5H9.75a.25.25 0 01-.25-.25V3.25c0-.223.27-.335.44-.19z"/>
                            </svg>
                            Joined GitHub: ${joined}
                        </div>
                    </section>`;

            const sectionPattern = /<section class="achievements\s+largeable-flex-wrap">[\s\S]*?<\/section>/;
            if (!sectionPattern.test(svg)) {
              core.setFailed("Could not locate achievements section in generated SVG.");
              return;
            }

            svg = svg.replace(sectionPattern, fallback);
            svg = svg.replace(/height="\d+"/, 'height="160"');

            const marker = /<!-- metrics-refresh:[^>]*-->/;
            const stamp = `<!-- metrics-refresh: run=${context.runId} at=${new Date().toISOString()} -->`;
            const updated = marker.test(svg)
              ? svg.replace(marker, stamp)
              : `${svg.trimEnd()}\n${stamp}\n`;

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `Patch ${path} fallback (run ${context.runId}) [skip ci]`,
              content: Buffer.from(updated, "utf8").toString("base64"),
              sha: file.sha,
              branch,
            });

      - name: Generate Pinned Repositories Card (Action-generated)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.repositories.pinned.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          base: ""
          plugin_repositories: yes
          plugin_repositories_pinned: 6
