name: Metrics Languages (Monthly)

on:
  schedule:
    # 00:00 at America/Fortaleza (UTC-3), day 1 of each month
    - cron: "0 3 1 * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_languages_indepth:
    runs-on: ubuntu-latest

    steps:
      - name: Build indepth repository list (pcce-redes + personal)
        id: indepth_repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          script: |
            const allowedOwners = new Set(["pcce-redes", "gabrielldn"]);
            const maxRepos = 500;
            const repos = [];
            const seen = new Set();
            const ownerCount = { "pcce-redes": 0, "gabrielldn": 0 };

            for (let page = 1; page <= 40; page++) {
              const { data } = await github.rest.repos.listForAuthenticatedUser({
                affiliation: "owner,collaborator,organization_member",
                sort: "pushed",
                direction: "desc",
                per_page: 100,
                page,
              });

              if (!data.length) break;

              for (const repo of data) {
                const owner = repo.owner && repo.owner.login ? repo.owner.login.toLowerCase() : "";
                if (!allowedOwners.has(owner)) continue;
                if (repo.disabled) continue;
                if (seen.has(repo.full_name)) continue;
                seen.add(repo.full_name);
                repos.push(repo.full_name);
                ownerCount[owner] = (ownerCount[owner] || 0) + 1;
                if (repos.length >= maxRepos) break;
              }

              if (repos.length >= maxRepos) break;
            }

            core.info(`Selected ${repos.length} repositories for indepth analysis.`);
            core.info(`Owner distribution: pcce-redes=${ownerCount["pcce-redes"]}, gabrielldn=${ownerCount["gabrielldn"]}`);
            core.info(repos.join(", "));
            core.setOutput("list", repos.join(","));

      - name: Generate Languages Card (indepth, monthly)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.languages.indepth.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          output_condition: always
          base: ""
          config_timezone: America/Fortaleza
          repositories: 500
          repositories_forks: yes
          repositories_affiliations: owner, collaborator, organization_member
          repositories_skipped: >-
            @use.patterns,
            -*/*,
            +pcce-redes/*,
            +gabrielldn/*
          commits_authoring: gabrielldn, GabrielLDN, Gabriel Lopes, gaellopes@protonmail.com, gabrielldn@users.noreply.github.com, 123586763+gabrielldn@users.noreply.github.com, 123586763+GabrielLDN@users.noreply.github.com
          plugin_languages: yes
          plugin_languages_ignored: __hidden, html, css, scss, tsx, typescript, typescript jsx, lua, HTML, CSS, SCSS, TSX, TypeScript, Lua
          plugin_languages_aliases: html:__hidden, css:__hidden, scss:__hidden, tsx:__hidden, typescript jsx:__hidden, typescript:__hidden, lua:__hidden
          plugin_languages_indepth: yes
          plugin_languages_indepth_custom: ${{ steps.indepth_repos.outputs.list }}
          plugin_languages_sections: most-used
          plugin_languages_details: lines, bytes-size, percentage
          plugin_languages_limit: 8
          plugin_languages_analysis_timeout: 60
          plugin_languages_analysis_timeout_repositories: 0

      - name: Force overwrite languages SVG on main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";
            const path = "metrics.plugin.languages.indepth.svg";

            const current = await github.rest.repos.getContent({
              owner,
              repo,
              path,
              ref: `heads/${branch}`,
            });

            const file = Array.isArray(current.data) ? null : current.data;
            if (!file || !file.content || !file.sha) {
              core.setFailed("Could not load generated SVG from repository.");
              return;
            }

            const decoded = Buffer.from(file.content, "base64").toString("utf8");
            const decorated = decoded.replace(/<small id="metrics-window">[^<]*<\/small>/, "");

            const marker = /<!-- metrics-refresh:[^>]*-->/;
            const stamp = `<!-- metrics-refresh: run=${context.runId} at=${new Date().toISOString()} -->`;
            const updated = marker.test(decorated)
              ? decorated.replace(marker, stamp)
              : `${decorated.trimEnd()}\n${stamp}\n`;

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `Force refresh ${path} (run ${context.runId}) [skip ci]`,
              content: Buffer.from(updated, "utf8").toString("base64"),
              sha: file.sha,
              branch,
            });
