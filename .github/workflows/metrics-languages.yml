name: Metrics Languages (Monthly)

on:
  schedule:
    # 00:00 at America/Fortaleza (UTC-3), day 1 of each month
    - cron: "0 3 1 * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_languages_indepth:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Languages Card (indepth, monthly)
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.languages.indepth.svg
          user: gabrielldn
          token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          committer_branch: main
          output_action: commit
          output_condition: always
          base: ""
          config_timezone: America/Fortaleza
          repositories: 500
          repositories_forks: yes
          repositories_affiliations: owner, collaborator, organization_member
          repositories_skipped: >-
            @use.patterns,
            -baiaotech/FrontendBaiaoTech,
            -opentalentpool/open-talent-pool
          commits_authoring: gabrielldn, GabrielLDN, Gabriel Lopes, gaellopes@protonmail.com, gabrielldn@users.noreply.github.com, 123586763+gabrielldn@users.noreply.github.com
          plugin_languages: yes
          plugin_languages_indepth: yes
          plugin_languages_sections: most-used
          plugin_languages_details: lines, bytes-size, percentage
          plugin_languages_recent_days: 30
          plugin_languages_limit: 8
          plugin_languages_analysis_timeout: 45
          plugin_languages_analysis_timeout_repositories: 12

      - name: Force overwrite languages SVG on main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PERSONAL_GAELLOPES || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";
            const path = "metrics.plugin.languages.indepth.svg";

            const current = await github.rest.repos.getContent({
              owner,
              repo,
              path,
              ref: `heads/${branch}`,
            });

            const file = Array.isArray(current.data) ? null : current.data;
            if (!file || !file.content || !file.sha) {
              core.setFailed("Could not load generated SVG from repository.");
              return;
            }

            const decoded = Buffer.from(file.content, "base64").toString("utf8");
            const marker = /<!-- metrics-refresh:[^>]*-->/;
            const stamp = `<!-- metrics-refresh: run=${context.runId} at=${new Date().toISOString()} -->`;
            const updated = marker.test(decoded)
              ? decoded.replace(marker, stamp)
              : `${decoded.trimEnd()}\n${stamp}\n`;

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `Force refresh ${path} (run ${context.runId}) [skip ci]`,
              content: Buffer.from(updated, "utf8").toString("base64"),
              sha: file.sha,
              branch,
            });
